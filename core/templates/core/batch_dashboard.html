{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Batch Results | NeuroVista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0b1b2e; --text:#e6f0ff; --muted:#9fb7d7; --accent:#3aa0ff;
      --glass: rgba(14,34,58,.42); --glass-border: rgba(255,255,255,.18);
    }
    html,body{ height:100%; margin:0; }
    body{
      background: radial-gradient(1200px 800px at 75% 40%, #112b46 0%, var(--ink) 60%) fixed;
      color: var(--text); font-family: 'Open Sans', sans-serif;
    }
    .bg-brain::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(90deg, rgba(11,27,46,.92) 0%, rgba(11,27,46,.82) 40%, rgba(11,27,46,.2) 75%, rgba(11,27,46,0) 100%),
        url("{% static 'img/brain_bg.jpg' %}") right center / cover no-repeat;
    }
    .nv-shell{ min-height:100dvh; padding:36px 16px; }
    .nv-title{ font-family:'Montserrat',sans-serif; font-weight:700; letter-spacing:.5px; margin:0; }
    .nv-subtle{ color:var(--muted); }
    .nv-card{
      background: var(--glass); backdrop-filter: blur(8px);
      border: 1px solid var(--glass-border); border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: clamp(20px,3vw,28px);
    }
    .btn-nv{ border-radius:12px !important; padding:12px 16px !important; font-weight:700; }
    .btn-nv-ghost{ color:var(--text); border:1px solid rgba(255,255,255,.35); background:transparent; }
    .btn-nv-ghost:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.55); }

    #loadingScreen{
      position:fixed; inset:0; z-index:9999;
      display:flex; justify-content:center; align-items:center; flex-direction:column;
      background: rgba(11,27,46,.92); color:var(--text); backdrop-filter: blur(4px);
    }
    .progress-outer{
      width:320px; height:22px; margin-top:14px; border-radius:12px; overflow:hidden;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
    }
    .progress-inner{
      height:100%; width:0%;
      background:linear-gradient(90deg,#3aa0ff 0%,#59b5ff 100%);
      text-align:center; color:#061320; font-weight:700; line-height:22px;
      transition: width 1.2s ease;
    }

    .chart-box{
      height: 360px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      padding:10px 10px 18px;
      overflow: hidden;
    }
    .chart-box .js-plotly-plot,
    .chart-box .plot-container,
    .chart-box .svg-container{ width:100% !important; height:100% !important; }
    .modebar, .modebar-container{ display:none !important; }
    .nv-table-wrap{
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .table.nv-table{ margin:0; color:#e9f1ff; }
    .table.nv-table thead th{
      background: rgba(255,255,255,.06);
      color:#cfe3ff;
      border-color: rgba(255,255,255,.12);
    }
    .table.nv-table tbody td{ border-color: rgba(255,255,255,.08); }
    .table.nv-table tbody tr:hover{ background: rgba(255,255,255,.06); }
    .table.nv-table th, .table.nv-table td{
      vertical-align: middle;
      padding: 10px 12px;
      font-size: .95rem;
    }
  </style>
</head>
<body class="bg-brain">

<div id="loadingScreen">
  <div class="text-center">
    <div class="spinner-border text-light" role="status" style="width:3rem;height:3rem;"></div>
    <h5 class="mt-3">Analyzing MRI images‚Ä¶</h5>
    <div class="progress-outer mt-2">
      <div class="progress-inner" id="progressBar">0%</div>
    </div>
  </div>
</div>

<div class="nv-shell container" id="mainContent" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="nv-title">üìä MRI Batch Analysis Results</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'research' %}" class="btn btn-nv btn-nv-ghost">üß™ Research Dashboard</a>
      <a href="{% url 'home' %}" class="btn btn-nv btn-nv-ghost">‚Üê Home</a>
    </div>
  </div>
  <p class="nv-subtle mb-4">Summary of detections, classifications, and measurements for your uploaded ZIP.</p>
  <div class="row g-4">
    <div class="col-md-6">
      <div class="nv-card">
        <h5 class="mb-2">Tumor Type Frequency</h5>
        <div class="chart-box" id="barBox">
          {{ bar_chart|safe }}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="nv-card">
        <h5 class="mb-2">Detection Outcome Distribution</h5>
        <div class="chart-box" id="pieBox">
          {{ pie_chart|safe }}
        </div>
      </div>
    </div>
  </div>
  <div class="nv-card mt-4">
    <h5 class="mb-3">üì¶ Processed Results: {{ results|length }}</h5>
    <div class="nv-table-wrap">
      <div class="table-responsive">
        <table class="table nv-table table-striped align-middle">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Detected</th>
              <th>Classified</th>
              <th class="text-end">Tumor Area (mm¬≤)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in results %}
            <tr>
              <td>{{ row.filename }}</td>
              <td>{{ row.detected }}</td>
              <td>{{ row.classified|default:'-' }}</td>
              <td class="text-end">{{ row.area|default:'-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let percent = 0;
  const bar = document.getElementById("progressBar");
  const screen = document.getElementById("loadingScreen");
  const mainContent = document.getElementById("mainContent");

  const simulateLoading = setInterval(() => {
    percent = Math.min(percent + 5, 100);
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';
    if (percent === 100) {
      clearInterval(simulateLoading);
      setTimeout(() => {
        screen.style.display = 'none';
        mainContent.style.display = 'block';
        setTimeout(styleAndResizePlots, 120);
      }, 400);
    }
  }, 120);

  function styleAndResizePlots(){
    const plots = document.querySelectorAll('#barBox .js-plotly-plot, #pieBox .js-plotly-plot');

    plots.forEach(el => {
      try {
        const box = el.closest('.chart-box');
        const w = Math.max(240, box.clientWidth  - 16);
        const h = Math.max(220, box.clientHeight - 16);

        let ymax = null, isBar = false, isPie = false;
        if (el.data) {
          el.data.forEach(tr => {
            if (tr.type === 'bar' && Array.isArray(tr.y)) {
              isBar = true;
              const m = Math.max(...tr.y.map(v => +v || 0));
              ymax = Math.max(ymax ?? 0, m);
            }
            if (tr.type === 'pie') isPie = true;
          });
        }
        const yRange = isBar && ymax ? [0, ymax * 1.18] : null;

        Plotly.relayout(el, {
          width: w, height: h, autosize: false,
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#e6f0ff' },
          margin: isPie ? { t: 24, l: 10, r: 10, b: 24 }
                        : { t: 24, l: 54, r: 16, b: 64 },
          'xaxis.automargin': true,
          'yaxis.automargin': true,
          'xaxis.gridcolor': 'rgba(255,255,255,.08)',
          'yaxis.gridcolor': 'rgba(255,255,255,.08)',
          'yaxis.range': yRange,
          bargap: 0.30,
          legend: { orientation: 'h', x: 0, y: -0.12, font: { color: '#e6f0ff' } }
        });

        if (el.data) {
          el.data.forEach((tr, idx) => {
            if (tr.type === 'bar' && Array.isArray(tr.y)) {
              Plotly.restyle(el, {
                text:[tr.y.map(v => String(v))],
                textposition:'auto',
                textfont:{ color:'#e6f0ff', size:12 },
                hovertemplate: '%{x}, %{y}<extra></extra>'
              }, idx);
            }
            if (tr.type === 'pie') {
              Plotly.restyle(el, {
                textinfo:'label+percent',
                insidetextorientation:'auto',
                textfont:{ color:'#e6f0ff', size:12 },
                hovertemplate: '%{label}, %{percent}<extra></extra>'
              }, idx);
            }
          });
        }

        Plotly.Plots.resize(el);
      } catch(e) {}
    });

    window.dispatchEvent(new Event('resize'));
  }

  window.addEventListener('resize', () => {
    clearTimeout(window.__plotlyResizeTimer);
    window.__plotlyResizeTimer = setTimeout(styleAndResizePlots, 100);
  });
</script>

</body>
</html>
